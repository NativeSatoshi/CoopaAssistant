<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coopa Asistan</title>
    <style>
        :root { --user-bg: #007bff; --model-bg: #e9e9eb; --text-light: #ffffff; --text-dark: #000000; }
        body { font-family: system-ui, sans-serif; max-width: 700px; margin: 0 auto; padding: 20px; background-color: #f7f7f7; display: flex; flex-direction: column; height: 95vh; }
        h1 { text-align: center; color: #333; flex-shrink: 0; }
        #chat-container { flex-grow: 1; overflow-y: auto; background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px; }
        .message { padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; max-width: 80%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--user-bg); color: var(--text-light); margin-left: auto; }
        .model-message { background-color: var(--model-bg); color: var(--text-dark); margin-right: auto; }
        .model-message a { color: #0056b3; }
        form { display: flex; gap: 10px; }
        input { flex-grow: 1; padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; }
        button { padding: 12px 22px; font-size: 16px; background-color: var(--user-bg); color: white; border: none; border-radius: 8px; cursor: pointer; }
        /* YENÄ°: Mikrofon butonu stilleri */
        #mic-button {
            padding: 12px;
            font-size: 20px;
            width: 50px;
            background-color: #6c757d;
        }
        #mic-button.listening { /* Dinleme sÄ±rasÄ±nda butonu kÄ±rmÄ±zÄ± yap */
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <h1>Coopa Asistan</h1>
    <div id="chat-container"></div>
    <form id="prompt-form">
        <input type="text" id="prompt-input" placeholder="Coopa'ya bir ÅŸey sor veya ðŸŽ¤" required>
        <button type="submit">GÃ¶nder</button>
        <button type="button" id="mic-button">ðŸŽ¤</button>
    </form>
    <script>
        // ... (Ã¶nceki deÄŸiÅŸken tanÄ±mlarÄ± aynÄ±)
        const promptForm = document.getElementById('prompt-form');
        const promptInput = document.getElementById('prompt-input');
        const chatContainer = document.getElementById('chat-container');
        let conversationHistory = [];

        // --- YENÄ°: Sesten Metne (Speech-to-Text) KodlarÄ± ---
        const micButton = document.getElementById('mic-button');
        
        // TarayÄ±cÄ±nÄ±n bu Ã¶zelliÄŸi destekleyip desteklemediÄŸini kontrol et
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'tr-TR'; // TÃ¼rkÃ§e dinleme yap
            recognition.continuous = false; // Tek bir cÃ¼mle sonrasÄ± dur
            
            micButton.addEventListener('click', () => {
                if (micButton.classList.contains('listening')) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            });
            
            recognition.onstart = () => {
                micButton.classList.add('listening');
                promptInput.placeholder = "Dinliyorum...";
            };

            recognition.onend = () => {
                micButton.classList.remove('listening');
                promptInput.placeholder = "Coopa'ya bir ÅŸey sor veya ðŸŽ¤";
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.trim();
                promptInput.value = transcript;
                // Ä°steÄŸe baÄŸlÄ±: Sesli komut sonrasÄ± otomatik gÃ¶nderme iÃ§in
                // promptForm.requestSubmit(); 
            };

            recognition.onerror = (event) => {
                alert('Ses tanÄ±ma hatasÄ±: ' + event.error);
            };

        } else {
            micButton.style.display = 'none'; // Desteklenmiyorsa butonu gizle
            alert("ÃœzgÃ¼nÃ¼m, tarayÄ±cÄ±nÄ±z ses tanÄ±ma Ã¶zelliÄŸini desteklemiyor.");
        }
        
        // --- Mevcut Kodlar (DeÄŸiÅŸiklik Yok) ---
        function linkify(text) { /* ...iÃ§erik aynÄ±... */ }
        function renderHistory(history) { /* ...iÃ§erik aynÄ±... */ }
        function renderConfirmation(details) { /* ...iÃ§erik aynÄ±... */ }
        async function executeAction(details) { /* ...iÃ§erik aynÄ±... */ }
        function cancelAction() { /* ...iÃ§erik aynÄ±... */ }
        promptForm.addEventListener('submit', async function(event) { /* ...iÃ§erik aynÄ±... */ });

        // --- FonksiyonlarÄ±n tam iÃ§erikleri (Kopyala-YapÄ±ÅŸtÄ±r iÃ§in) ---
        function linkify(text) { const urlRegex = /(https?:\/\/[^\s]+)/g; return text.replace(urlRegex, (url) => `<a href="${url}" target="_blank">${url}</a>`); }
        function renderHistory(history) { conversationHistory = history; chatContainer.innerHTML = ''; for (const message of history) { if (message.role === 'function') continue; if (message.parts && message.parts[0]) { const messageDiv = document.createElement('div'); messageDiv.classList.add('message', message.role === 'user' ? 'user-message' : 'model-message'); if (message.parts[0].text) { messageDiv.innerHTML = linkify(message.parts[0].text); } else if (message.parts[0].functionCall) { messageDiv.innerText = `[Coopa, ${message.parts[0].functionCall.name} aracÄ±nÄ± kullanÄ±yor...]`; messageDiv.style.fontStyle = 'italic'; } chatContainer.appendChild(messageDiv); } } chatContainer.scrollTop = chatContainer.scrollHeight; }
        function renderConfirmation(details) { const confirmationDiv = document.createElement('div'); confirmationDiv.className = 'message model-message'; confirmationDiv.innerHTML = `<p><strong>LÃ¼tfen OnaylayÄ±n</strong></p><p>E-posta gÃ¶nderilecek: ${details.to}</p>`; const yesButton = document.createElement('button'); yesButton.innerText = 'Evet, GÃ¶nder'; yesButton.onclick = () => executeAction(details); const noButton = document.createElement('button'); noButton.innerText = 'HayÄ±r, Ä°ptal Et'; noButton.onclick = () => cancelAction(); confirmationDiv.append(yesButton, noButton); chatContainer.appendChild(confirmationDiv); }
        async function executeAction(details) { const response = await fetch('/execute-action', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ actionName: 'send_email', ...details, history: conversationHistory }) }); const data = await response.json(); if (data.history) renderHistory(data.history); }
        function cancelAction() { conversationHistory.push({ role: 'model', parts: [{ text: 'Ä°ÅŸlem iptal edildi.' }] }); renderHistory(conversationHistory); }
        promptForm.addEventListener('submit', async function(event) { event.preventDefault(); const prompt = promptInput.value; if(!prompt.trim()) return; promptInput.value = ''; const response = await fetch('/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt, history: conversationHistory }) }); const data = await response.json(); if (data.history) renderHistory(data.history); if (data.requires_confirmation) renderConfirmation(data.action_details); });
    </script>
</body>
</html>