<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coopa Asistan</title>
    <style>
        :root { --user-bg: #007bff; --model-bg: #e9e9eb; --text-light: #ffffff; --text-dark: #000000; }
        body { font-family: system-ui, sans-serif; max-width: 700px; margin: 0 auto; padding: 20px; background-color: #f7f7f7; display: flex; flex-direction: column; height: 95vh; }
        h1 { text-align: center; color: #333; flex-shrink: 0; }
        #auth-container { text-align: center; margin-bottom: 15px; padding: 10px; background-color: #fff; border: 1px solid #ddd; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; gap: 20px;}
        #google-auth-section { flex-grow: 1; text-align: left; }
        #wallet-auth-section { text-align: right; }
        #auth-container a { text-decoration: none; color: var(--user-bg); font-weight: bold; }
        #connect-wallet-button { padding: 8px 16px; font-size: 14px; background-color: #ff9800; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #wallet-info { font-size: 12px; color: #555; background-color: #f0f0f0; padding: 5px 10px; border-radius: 12px; margin-top: 5px;}
        #chat-container { flex-grow: 1; overflow-y: auto; background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px; }
        
        #upload-section { background-color: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd;}
        #upload-section h3 { margin-top: 0; text-align: center; color: #495057; }
        #upload-form { display: flex; flex-direction: column; gap: 10px; }
        #upload-form input[type="text"], #upload-form input[type="file"] { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #upload-form button { background-color: #28a745; }

        .message { padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; max-width: 80%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--user-bg); color: var(--text-light); margin-left: auto; }
        .model-message { background-color: var(--model-bg); color: var(--text-dark); margin-right: auto; }
        #prompt-form { display: flex; gap: 10px; }
        #prompt-form input[type="text"] { flex-grow: 1; padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; }
        button { padding: 12px; font-size: 16px; background-color: var(--user-bg); color: white; border: none; border-radius: 8px; cursor: pointer; }
        #mic-button, #tts-button { font-size: 20px; width: 50px; flex-shrink: 0; background-color: #6c757d; } 
        #mic-button.listening { background-color: #dc3545; }
        button#submit-button { padding: 12px 22px; }
        input:disabled, button:disabled { background-color: #e9ecef; cursor: not-allowed; }
        button:disabled { background-color: #999; }
    </style>
</head>
<body>
    <h1>Coopa Asistan</h1>
    <div id="auth-container">
        <div id="google-auth-section"><a href="/auth/google">Google Takvim'e Baƒülan</a></div>
        <div id="wallet-auth-section">
             <button id="connect-wallet-button">ü¶ä C√ºzdanla Baƒülan</button>
             <p id="wallet-info" style="display: none;"></p>
        </div>
    </div>
    <div id="chat-container"></div>
    
    <div id="upload-section">
        <h3>üñºÔ∏è Kalƒ±cƒ± Anƒ± Y√ºkle</h3>
        <form id="upload-form" action="/upload" method="POST" enctype="multipart/form-data">
            <input type="file" name="memoryFile" id="file-input" required>
            <input type="text" name="description" id="description-input" placeholder="Dosya i√ßin kƒ±sa bir a√ßƒ±klama..." required>
            <button type="submit">Anƒ±yƒ± Kalƒ±cƒ± Olarak Kaydet</button>
        </form>
    </div>
    
    <div id="loading-indicator" style="text-align: center; display: none; padding: 20px;"><p>Yanƒ±t hazƒ±rlanƒ±yor...</p></div>
    <form id="prompt-form">
        <input type="text" id="prompt-input" placeholder="Coopa'ya bir ≈üey sor...">
        <button type="submit" id="submit-button">G√∂nder</button>
        <button type="button" id="mic-button">üé§</button>
        <button type="button" id="tts-button">üîä</button> 
    </form>

    <script>
        const elements = { 
            form: document.getElementById('prompt-form'), 
            input: document.getElementById('prompt-input'), 
            chatContainer: document.getElementById('chat-container'), 
            submitButton: document.getElementById('submit-button'), 
            loadingIndicator: document.getElementById('loading-indicator'), 
            micButton: document.getElementById('mic-button'), 
            ttsButton: document.getElementById('tts-button'),
            connectWalletButton: document.getElementById('connect-wallet-button'),
            walletInfo: document.getElementById('wallet-info'),
            googleAuthSection: document.getElementById('google-auth-section')
        };

        let conversationHistory = [];
        let isWalletConnected = false;
        let isTtsEnabled = localStorage.getItem('ttsEnabled') === 'true';
        const synth = window.speechSynthesis;

        const speak = (text) => {
            if (!isTtsEnabled || !text) return;
            if (synth.speaking) synth.cancel();
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.lang = 'tr-TR';
            synth.speak(utterThis);
        };

        const toggleForm = (disabled, reason = 'loading') => { 
            elements.input.disabled = disabled; 
            elements.submitButton.disabled = disabled; 
            elements.micButton.disabled = disabled; 
            elements.ttsButton.disabled = disabled; 
            elements.loadingIndicator.style.display = (disabled && reason === 'loading') ? 'block' : 'none'; 
            if (disabled) {
                if (reason === 'wallet') elements.input.placeholder = "ƒ∞≈ülem i√ßin l√ºtfen √∂nce c√ºzdanƒ±nƒ±zƒ± baƒülayƒ±n...";
            } else {
                elements.input.placeholder = "Coopa'ya bir ≈üey sor veya üé§";
                elements.input.focus();
            }
        };
        
        const renderHistory = () => {
            elements.chatContainer.innerHTML = '';
            let lastModelMessageText = '';
            conversationHistory.forEach(message => {
                if (message.role === 'function' || !message.parts?.[0]) return;
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', message.role === 'user' ? 'user-message' : 'model-message');
                const part = message.parts[0];
                if (part.text) {
                    const linkify = (text) => text.replace(/(https?:\/\/[^\s]+)/g, (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
                    messageDiv.innerHTML = linkify(part.text);
                    if (message.role === 'model') lastModelMessageText = part.text;
                } else if (part.functionCall) {
                    messageDiv.innerText = `[Coopa, ${part.functionCall.name} aracƒ±nƒ± kullanƒ±yor...]`;
                    messageDiv.style.fontStyle = 'italic';
                }
                elements.chatContainer.appendChild(messageDiv);
            });
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
            speak(lastModelMessageText);
        };
        
        const handleFormSubmit = async (event) => {
            if (event) event.preventDefault();
            if (!isWalletConnected) {
                alert("L√ºtfen i≈ülem yapmadan √∂nce c√ºzdanƒ±nƒ±zƒ± baƒülayƒ±n.");
                return;
            }
            const prompt = elements.input.value;
            if (!prompt.trim()) return;
            
            conversationHistory.push({ role: 'user', parts: [{ text: prompt }] });
            renderHistory();
            toggleForm(true, 'loading');
            elements.input.value = '';
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt, history: conversationHistory.slice(0, -1) })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Sunucu hatasƒ±');

                conversationHistory = data.history;
                
            } catch (error) {
                conversationHistory.push({ role: 'model', parts: [{ text: `Bir hata olu≈ütu: ${error.message}` }] });
            } finally {
                renderHistory();
                toggleForm(isWalletConnected ? false : true, 'wallet');
            }
        };

        elements.form.addEventListener('submit', handleFormSubmit);

        const connectWallet = async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const account = accounts[0];
                    isWalletConnected = true; 
                    const shortAddress = `${account.substring(0, 6)}...${account.substring(account.length - 4)}`;
                    elements.walletInfo.textContent = `Baƒülandƒ±: ${shortAddress}`;
                    elements.walletInfo.style.display = 'block';
                    elements.connectWalletButton.style.display = 'none';
                    toggleForm(false); 
                } catch (error) {
                    elements.walletInfo.textContent = 'Baƒülantƒ± ba≈üarƒ±sƒ±z oldu.';
                    elements.walletInfo.style.display = 'block';
                }
            } else {
                alert('L√ºtfen bu √∂zelliƒüi kullanmak i√ßin MetaMask c√ºzdanƒ±nƒ± kurun.');
            }
        };
        elements.connectWalletButton.addEventListener('click', connectWallet);

        const updateTtsButtonIcon = () => elements.ttsButton.textContent = isTtsEnabled ? 'üîä' : 'üîá';
        
        window.onload = () => {
            toggleForm(true, 'wallet');
            updateTtsButtonIcon();
            elements.ttsButton.addEventListener('click', () => {
                isTtsEnabled = !isTtsEnabled;
                localStorage.setItem('ttsEnabled', isTtsEnabled ? 'true' : 'false');
                updateTtsButtonIcon();
                if (!isTtsEnabled) synth.cancel();
            });

            const params = new URLSearchParams(window.location.search);
            if (params.get('auth')) {
                const authStatus = params.get('auth');
                const div = document.createElement('div');
                div.innerText = authStatus === 'success' ? '‚úÖ Google Takvim\'e ba≈üarƒ±yla baƒülandƒ±nƒ±z!' : '‚ùå Google Takvim\'e baƒülanƒ±rken bir hata olu≈ütu.';
                div.style.color = authStatus === 'success' ? 'green' : 'red';
                elements.googleAuthSection.innerHTML = '';
                elements.googleAuthSection.appendChild(div);
                speak(div.innerText);
            }
        };
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'tr-TR';
            recognition.continuous = false;
            
            elements.micButton.addEventListener('click', () => {
                if (!isWalletConnected) {
                    alert("L√ºtfen sesli komut kullanmadan √∂nce c√ºzdanƒ±nƒ±zƒ± baƒülayƒ±n.");
                    return;
                }
                synth.cancel();
                recognition.start();
            });
            
            recognition.onstart = () => { elements.micButton.classList.add('listening'); elements.input.placeholder = "Dinliyorum..."; };
            recognition.onend = () => { elements.micButton.classList.remove('listening'); if (isWalletConnected) { elements.input.placeholder = "Coopa'ya bir ≈üey sor veya üé§"; } };
            recognition.onresult = (event) => { const transcript = event.results[event.results.length - 1][0].transcript.trim(); elements.input.value = transcript; handleFormSubmit(); };
            recognition.onerror = (event) => { alert('Ses tanƒ±ma hatasƒ±: ' + event.error); };
        } else {
            elements.micButton.style.display = 'none';
        }
    </script>
</body>
</html>