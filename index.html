<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coopa Asistan</title>
    <style>
        :root { --user-bg: #007bff; --model-bg: #e9e9eb; --text-light: #ffffff; --text-dark: #000000; }
        body { font-family: system-ui, sans-serif; max-width: 700px; margin: 0 auto; padding: 20px; background-color: #f7f7f7; display: flex; flex-direction: column; height: 95vh; }
        h1 { text-align: center; color: #333; flex-shrink: 0; }
        #auth-container { text-align: center; margin-bottom: 15px; padding: 10px; background-color: #fff; border: 1px solid #ddd; border-radius: 8px; }
        #auth-container a { text-decoration: none; color: var(--user-bg); font-weight: bold; }
        #chat-container { flex-grow: 1; overflow-y: auto; background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px; }
        .message { padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; max-width: 80%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--user-bg); color: var(--text-light); margin-left: auto; }
        .model-message { background-color: var(--model-bg); color: var(--text-dark); margin-right: auto; }
        .model-message a { color: #0056b3; }
        form { display: flex; gap: 10px; }
        input[type="text"] { flex-grow: 1; padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; }
        button { padding: 12px; font-size: 16px; background-color: var(--user-bg); color: white; border: none; border-radius: 8px; cursor: pointer; }
        #mic-button, #tts-button { font-size: 20px; width: 50px; flex-shrink: 0; background-color: #6c757d; } /* YENÄ°: TTS butonu eklendi */
        #mic-button.listening { background-color: #dc3545; }
        button#submit-button { padding: 12px 22px; }
        button:disabled { background-color: #999; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>Coopa Asistan</h1>
    <div id="auth-container"><a href="/auth/google">Google Takvim'e BaÄŸlan ve Yetki Ver</a></div>
    <div id="chat-container"></div>
    <div id="loading-indicator" style="text-align: center; display: none; padding: 20px;"><p>YanÄ±t hazÄ±rlanÄ±yor...</p></div>
    <form id="prompt-form">
        <input type="text" id="prompt-input" placeholder="Coopa'ya bir ÅŸey sor veya ğŸ¤">
        <button type="submit" id="submit-button">GÃ¶nder</button>
        <button type="button" id="mic-button">ğŸ¤</button>
        <button type="button" id="tts-button">ğŸ”Š</button> 
    </form>

    <script>
        const elements = { 
            form: document.getElementById('prompt-form'), 
            input: document.getElementById('prompt-input'), 
            chatContainer: document.getElementById('chat-container'), 
            micButton: document.getElementById('mic-button'), 
            submitButton: document.getElementById('submit-button'), 
            loadingIndicator: document.getElementById('loading-indicator'), 
            authContainer: document.getElementById('auth-container'),
            ttsButton: document.getElementById('tts-button') // YENÄ°: TTS butonu referansÄ±
        };

        let conversationHistory = [];
        // YENÄ°: TTS durumunu yÃ¶neten deÄŸiÅŸken (tarayÄ±cÄ± hafÄ±zasÄ±ndan okunur)
        let isTtsEnabled = localStorage.getItem('ttsEnabled') === 'false' ? false : true;

        const synth = window.speechSynthesis;

        // GÃœNCELLEME: 'speak' fonksiyonu artÄ±k 'isTtsEnabled' durumunu kontrol ediyor
        const speak = (text) => {
            if (!isTtsEnabled) return; // EÄŸer TTS kapalÄ±ysa, fonksiyondan Ã§Ä±k

            if (synth.speaking) {
                synth.cancel(); 
            }
            if (text) {
                const utterThis = new SpeechSynthesisUtterance(text);
                utterThis.lang = 'tr-TR';
                synth.speak(utterThis);
            }
        };
        
        const linkify = (text) => text.replace(/(https?:\/\/[^\s]+)/g, (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
        
        // GÃœNCELLEME: 'toggleForm' artÄ±k TTS butonunu da devre dÄ±ÅŸÄ± bÄ±rakÄ±yor
        const toggleForm = (disabled) => { 
            elements.input.disabled = disabled; 
            elements.submitButton.disabled = disabled; 
            elements.micButton.disabled = disabled; 
            elements.ttsButton.disabled = disabled; // YENÄ°
            elements.loadingIndicator.style.display = disabled ? 'block' : 'none'; 
            if (!disabled) elements.input.focus(); 
        };
        
        const renderHistory = (history) => {
            if (!Array.isArray(history)) return;
            conversationHistory = history;
            elements.chatContainer.innerHTML = '';
            let lastModelMessageText = '';
            for (const message of history) {
                if (message.role === 'function' || !message.parts?.[0]) continue;
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', message.role === 'user' ? 'user-message' : 'model-message');
                const part = message.parts[0];
                if (part.text) {
                    messageDiv.innerHTML = linkify(part.text);
                    if (message.role === 'model') lastModelMessageText = part.text;
                } else if (part.functionCall) {
                    const toolText = `[Coopa, ${part.functionCall.name} aracÄ±nÄ± kullanÄ±yor...]`;
                    messageDiv.innerText = toolText;
                    messageDiv.style.fontStyle = 'italic';
                    if (message.role === 'model') lastModelMessageText = toolText;
                }
                elements.chatContainer.appendChild(messageDiv);
            }
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
            speak(lastModelMessageText);
        };
        
        const renderConfirmation = (details) => {
            const confirmationDiv = document.createElement('div');
            confirmationDiv.className = 'message model-message';
            const confirmationText = `LÃ¼tfen OnaylayÄ±n: E-posta gÃ¶nderilecek: ${details.to}`;
            confirmationDiv.innerHTML = `<p><strong>LÃ¼tfen OnaylayÄ±n</strong></p><p>E-posta gÃ¶nderilecek: ${details.to}</p>`;
            const yesButton = document.createElement('button');
            yesButton.innerText = 'Evet, GÃ¶nder';
            yesButton.onclick = () => executeAction(details);
            const noButton = document.createElement('button');
            noButton.innerText = 'HayÄ±r, Ä°ptal Et';
            noButton.onclick = () => cancelAction();
            confirmationDiv.append(yesButton, noButton);
            elements.chatContainer.appendChild(confirmationDiv);
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
            speak(confirmationText);
        };

        const executeAction = async (details) => { toggleForm(true); try { const response = await fetch('/execute-action', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ actionName: 'send_email', ...details, history: conversationHistory }) }); const data = await response.json(); if (data.history) renderHistory(data.history); } catch (e) { renderHistory([...conversationHistory, { role: 'model', parts: [{ text: `Hata: ${e.message}` }] }]); } finally { toggleForm(false); } };
        const cancelAction = () => { renderHistory([...conversationHistory, { role: 'model', parts: [{ text: 'Ä°ÅŸlem iptal edildi.' }] }]); };
        
        const handleFormSubmit = async (event) => {
            event.preventDefault();
            const prompt = elements.input.value;
            if (!prompt.trim()) return;
            toggleForm(true);
            const newHistory = [...conversationHistory, { role: 'user', parts: [{ text: prompt }] }];
            renderHistory(newHistory);
            elements.input.value = '';
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt, history: conversationHistory })
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: response.statusText }));
                    throw new Error(errorData.error || `Sunucu hatasÄ±: ${response.statusText}`);
                }
                const data = await response.json();
                if (data.history) renderHistory(data.history);
                if (data.requires_confirmation) renderConfirmation(data.action_details);
            } catch (error) {
                renderHistory([...conversationHistory, { role: 'model', parts: [{ text: `Bir hata oluÅŸtu: ${error.message}` }] }]);
            } finally {
                toggleForm(false);
            }
        };

        elements.form.addEventListener('submit', handleFormSubmit);

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) { const recognition = new SpeechRecognition(); recognition.lang = 'tr-TR'; recognition.continuous = false; elements.micButton.addEventListener('click', () => { synth.cancel(); recognition.start(); }); recognition.onstart = () => { elements.micButton.classList.add('listening'); elements.input.placeholder = "Dinliyorum..."; }; recognition.onend = () => { elements.micButton.classList.remove('listening'); elements.input.placeholder = "Coopa'ya bir ÅŸey sor veya ğŸ¤"; }; recognition.onresult = (event) => { elements.input.value = event.results[event.results.length - 1][0].transcript.trim(); elements.form.dispatchEvent(new Event('submit')); }; recognition.onerror = (event) => { alert('Ses tanÄ±ma hatasÄ±: ' + event.error); }; } else { elements.micButton.style.display = 'none'; }
        
        // --- YENÄ°: TTS Butonunu YÃ¶neten Kod BloÄŸu ---
        const updateTtsButtonIcon = () => {
            elements.ttsButton.textContent = isTtsEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
        };

        elements.ttsButton.addEventListener('click', () => {
            isTtsEnabled = !isTtsEnabled; // Durumu tersine Ã§evir
            localStorage.setItem('ttsEnabled', isTtsEnabled); // SeÃ§imi tarayÄ±cÄ± hafÄ±zasÄ±na kaydet
            updateTtsButtonIcon(); // Ä°konu gÃ¼ncelle
            if (!isTtsEnabled) {
                synth.cancel(); // EÄŸer kapatÄ±ldÄ±ysa, mevcut konuÅŸmayÄ± sustur
            }
        });

        window.onload = () => { 
            updateTtsButtonIcon(); // Sayfa yÃ¼klendiÄŸinde doÄŸru ikonu ayarla
            const params = new URLSearchParams(window.location.search); 
            if (params.get('auth') === 'success') { const successDiv = document.createElement('div'); const successText = 'Google Takvim\'e baÅŸarÄ±yla baÄŸlandÄ±nÄ±z!'; successDiv.innerText = `âœ… ${successText}`; successDiv.style.color = 'green'; elements.authContainer.innerHTML = ''; elements.authContainer.appendChild(successDiv); speak(successText); } else if (params.get('auth') === 'error') { const errorDiv = document.createElement('div'); const errorText = 'Google Takvim\'e baÄŸlanÄ±rken bir hata oluÅŸtu.'; errorDiv.innerText = `âŒ ${errorText}`; errorDiv.style.color = 'red'; elements.authContainer.appendChild(errorDiv); speak(errorText); }
        };
    </script>
</body>
</html>