<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coopa Asistan</title>
    <style>
        :root { --user-bg: #007bff; --model-bg: #e9e9eb; --text-light: #ffffff; --text-dark: #000000; }
        body { font-family: system-ui, sans-serif; max-width: 700px; margin: 0 auto; padding: 20px; background-color: #f7f7f7; display: flex; flex-direction: column; height: 95vh; }
        h1 { text-align: center; color: #333; flex-shrink: 0; }
        #language-selector { text-align: center; margin-bottom: 15px; }
        #language-selector select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; }
        #auth-container { text-align: center; margin-bottom: 15px; padding: 10px; background-color: #fff; border: 1px solid #ddd; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; gap: 20px;}
        #google-auth-section { flex-grow: 1; text-align: left; }
        #wallet-auth-section { text-align: right; }
        #auth-container a { text-decoration: none; color: var(--user-bg); font-weight: bold; }
        #connect-wallet-button { padding: 8px 16px; font-size: 14px; background-color: #ff9800; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #wallet-info { font-size: 12px; color: #555; background-color: #f0f0f0; padding: 5px 5px 5px 10px; border-radius: 12px; margin-top: 5px;}
        #chat-container { flex-grow: 1; overflow-y: auto; background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px; }
        #upload-section { background-color: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd;}
        #upload-section h3 { margin-top: 0; text-align: center; color: #495057; }
        #upload-form { display: flex; flex-direction: column; gap: 10px; }
        #upload-form input[type="text"] { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #upload-form button { background-color: #28a745; }
        .message { padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; max-width: 80%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--user-bg); color: var(--text-light); margin-left: auto; }
        .model-message { background-color: var(--model-bg); color: var(--text-dark); margin-right: auto; }
        .memory-image { max-width: 100%; border-radius: 12px; margin-top: 10px; cursor: pointer; }
        #prompt-form { display: flex; gap: 10px; }
        #prompt-form input[type="text"] { flex-grow: 1; padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; }
        button { padding: 12px; font-size: 16px; background-color: var(--user-bg); color: white; border: none; border-radius: 8px; cursor: pointer; }
        #mic-button, #tts-button { font-size: 20px; width: 50px; flex-shrink: 0; background-color: #6c757d; } 
        #mic-button.listening { background-color: #dc3545; }
        button#submit-button { padding: 12px 22px; }
        input:disabled, button:disabled { background-color: #e9ecef; cursor: not-allowed; }
        button:disabled { background-color: #999; }
        .language-flag { display: inline-block; margin-right: 5px; }

        .custom-file-upload { border: 1px solid #ccc; display: flex; padding: 0; border-radius: 4px; background-color: white; overflow: hidden; }
        #file-input-label { display: inline-block; padding: 8px 12px; background-color: #e9e9e9; color: #555; cursor: pointer; border-right: 1px solid #ccc; font-size: 14px; }
        #file-chosen { padding: 8px 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 14px; color: #777; flex-grow: 1; }
        
        #logout-button { background-color: #6c757d; color: white; padding: 2px 8px; font-size: 12px; border-radius: 4px; font-weight: bold; line-height: 1.5; min-width: 25px; }
        #logout-button:hover { background-color: #dc3545; }
    </style>
</head>
<body>
    
    <h1 id="main-title">Coopa Asistan</h1>
    
  <div id="language-selector">
    <select id="language-select">
        <option value="tr">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</option>
        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
        <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
        <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
    </select>
</div>
    
    <div id="auth-container">
        <div id="google-auth-section">
            <a href="/auth/google" id="google-auth-link">Google Takvim'e BaÄŸlan</a>
        </div>
        <div id="wallet-auth-section">
            <button id="connect-wallet-button">ğŸ¦Š CÃ¼zdan ile GiriÅŸ Yap</button>
            <p id="wallet-info" style="display: none; align-items: center; gap: 8px;">
                <span id="wallet-address"></span>
                <button id="logout-button" title="Oturumu Kapat">X</button>
            </p>
        </div>
    </div>
    
    <div id="chat-container"></div>
    
    <div id="upload-section">
        <h3 id="upload-title">ğŸ–¼ï¸ KiÅŸisel AnÄ± YÃ¼kle</h3>
        <form id="upload-form">
            <input type="file" name="memoryFile" id="file-input" required style="display: none;">
            <div class="custom-file-upload">
                <label for="file-input" id="file-input-label">Dosya SeÃ§</label>
                <span id="file-chosen">SeÃ§ilen dosya yok</span>
            </div>
            <input type="text" name="description" id="description-input" placeholder="Dosya iÃ§in kÄ±sa bir aÃ§Ä±klama..." required>
            <button type="submit" id="upload-button">AnÄ±yÄ± KalÄ±cÄ± Olarak Kaydet</button>
        </form>
    </div>
    
    <div id="loading-indicator" style="text-align: center; display: none; padding: 20px;">
        <p id="loading-text">YanÄ±t hazÄ±rlanÄ±yor...</p>
    </div>
    
    <form id="prompt-form">
        <input type="text" id="prompt-input" placeholder="Coopa'ya bir ÅŸey sor...">
        <button type="submit" id="submit-button">GÃ¶nder</button>
        <button type="button" id="mic-button">ğŸ¤</button>
        <button type="button" id="tts-button">ğŸ”Š</button> 
    </form>

    <script>
        const translations = {
            tr: {
                mainTitle: "Coopa Asistan",
                googleAuth: "Google Takvim'e BaÄŸlan",
                walletConnect: "ğŸ¦Š CÃ¼zdan ile GiriÅŸ Yap",
                uploadTitle: "ğŸ–¼ï¸ KiÅŸisel AnÄ± YÃ¼kle",
                descriptionPlaceholder: "Dosya iÃ§in kÄ±sa bir aÃ§Ä±klama...",
                uploadButton: "AnÄ±yÄ± KalÄ±cÄ± Olarak Kaydet",
                promptPlaceholder: "Coopa'ya bir ÅŸey sor...",
                promptPlaceholderMic: "Coopa'ya bir ÅŸey sor veya ğŸ¤",
                submitButton: "GÃ¶nder",
                loadingText: "YanÄ±t hazÄ±rlanÄ±yor...",
                listeningText: "Dinliyorum...",
                walletConnectFirst: "Ä°ÅŸlem iÃ§in lÃ¼tfen Ã¶nce cÃ¼zdanÄ±nÄ±zÄ± baÄŸlayÄ±n...",
                walletLoginFirst: "LÃ¼tfen iÅŸlem yapmadan Ã¶nce cÃ¼zdanÄ±nÄ±zÄ± baÄŸlayÄ±n.",
                selectFile: "LÃ¼tfen bir dosya seÃ§in.",
                uploading: "Dosya yÃ¼kleniyor, bu iÅŸlem biraz zaman alabilir...",
                uploadError: "YÃ¼kleme sÄ±rasÄ±nda bir hata oluÅŸtu:",
                loginRequired: "GiriÅŸ yapmak iÃ§in mesajÄ± imzalamanÄ±z gerekmektedir.",
                installMetaMask: "LÃ¼tfen bu Ã¶zelliÄŸi kullanmak iÃ§in MetaMask cÃ¼zdanÄ±nÄ± kurun.",
                voiceLoginRequired: "LÃ¼tfen sesli komut kullanmadan Ã¶nce cÃ¼zdanÄ±nÄ±zÄ± baÄŸlayÄ±n.",
                speechError: "Ses tanÄ±ma hatasÄ±:",
                loginSuccess: "GiriÅŸ YapÄ±ldÄ±:",
                googleAuthSuccess: "âœ… Google Takvim'e baÅŸarÄ±yla baÄŸlandÄ±nÄ±z!",
                googleAuthError: "âŒ Google Takvim'e baÄŸlanÄ±rken bir hata oluÅŸtu.",
                popupBlocked: "TarayÄ±cÄ±nÄ±z pop-up'Ä± engelledi. BaÅŸarÄ± mesajÄ±nÄ± gÃ¶rmek iÃ§in lÃ¼tfen bu site iÃ§in pop-up'lara izin verin.",
                chooseFileButton: "Dosya SeÃ§",
                noFileChosen: "SeÃ§ilen dosya yok",
                logoutTitle: "Oturumu Kapat"
            },
            en: {
                mainTitle: "Coopa Assistant",
                googleAuth: "Connect to Google Calendar",
                walletConnect: "ğŸ¦Š Login with Wallet",
                uploadTitle: "ğŸ–¼ï¸ Upload Personal Memory",
                descriptionPlaceholder: "Short description for the file...",
                uploadButton: "Save Memory Permanently",
                promptPlaceholder: "Ask Coopa something...",
                promptPlaceholderMic: "Ask Coopa something or ğŸ¤",
                submitButton: "Send",
                loadingText: "Preparing response...",
                listeningText: "Listening...",
                walletConnectFirst: "Please connect your wallet first for transactions...",
                walletLoginFirst: "Please connect your wallet before proceeding.",
                selectFile: "Please select a file.",
                uploading: "File uploading, this may take a moment...",
                uploadError: "An error occurred during upload:",
                loginRequired: "You need to sign the message to log in.",
                installMetaMask: "Please install MetaMask wallet to use this feature.",
                voiceLoginRequired: "Please connect your wallet before using voice commands.",
                speechError: "Speech recognition error:",
                loginSuccess: "Logged In:",
                googleAuthSuccess: "âœ… Successfully connected to Google Calendar!",
                googleAuthError: "âŒ An error occurred while connecting to Google Calendar.",
                popupBlocked: "Your browser blocked the pop-up. Please allow pop-ups for this site to see the success message.",
                chooseFileButton: "Choose File",
                noFileChosen: "No file chosen",
                logoutTitle: "Log Out"
            },
            es: {
                mainTitle: "Asistente Coopa",
                googleAuth: "Conectar a Google Calendar",
                walletConnect: "ğŸ¦Š Iniciar SesiÃ³n con Wallet",
                uploadTitle: "ğŸ–¼ï¸ Subir Memoria Personal",
                descriptionPlaceholder: "DescripciÃ³n breve del archivo...",
                uploadButton: "Guardar Memoria Permanentemente",
                promptPlaceholder: "PregÃºntale algo a Coopa...",
                promptPlaceholderMic: "PregÃºntale algo a Coopa o ğŸ¤",
                submitButton: "Enviar",
                loadingText: "Preparando respuesta...",
                listeningText: "Escuchando...",
                walletConnectFirst: "Por favor conecta tu wallet primero para transacciones...",
                walletLoginFirst: "Por favor conecta tu wallet antes de continuar.",
                selectFile: "Por favor selecciona un archivo.",
                uploading: "Subiendo archivo, esto puede tomar un momento...",
                uploadError: "OcurriÃ³ un error durante la subida:",
                loginRequired: "Necesitas firmar el mensaje para iniciar sesiÃ³n.",
                installMetaMask: "Por favor instala la wallet MetaMask para usar esta funciÃ³n.",
                voiceLoginRequired: "Por favor conecta tu wallet antes de usar comandos de voz.",
                speechError: "Error de reconocimiento de voz:",
                loginSuccess: "SesiÃ³n Iniciada:",
                googleAuthSuccess: "âœ… Â¡Conectado exitosamente a Google Calendar!",
                googleAuthError: "âŒ OcurriÃ³ un error al conectar con Google Calendar.",
                popupBlocked: "Tu navegador bloqueÃ³ la ventana emergente. Por favor, permite las ventanas emergentes para este sitio para ver el mensaje de Ã©xito.",
                chooseFileButton: "Seleccionar Archivo",
                noFileChosen: "NingÃºn archivo seleccionado",
                logoutTitle: "Cerrar SesiÃ³n"
            },
            fr: {
    mainTitle: "Assistant Coopa",
    googleAuth: "Se connecter Ã  Google Calendar",
    walletConnect: "ğŸ¦Š Se connecter avec Wallet",
    uploadTitle: "ğŸ–¼ï¸ TÃ©lÃ©charger MÃ©moire Personnelle",
    descriptionPlaceholder: "BrÃ¨ve description du fichier...",
    uploadButton: "Sauvegarder la MÃ©moire DÃ©finitivement",
    promptPlaceholder: "Demandez quelque chose Ã  Coopa...",
    promptPlaceholderMic: "Demandez quelque chose Ã  Coopa ou ğŸ¤",
    submitButton: "Envoyer",
    loadingText: "PrÃ©paration de la rÃ©ponse...",
    listeningText: "Ã‰coute...",
    walletConnectFirst: "Veuillez d'abord connecter votre wallet pour les transactions...",
    walletLoginFirst: "Veuillez connecter votre wallet avant de faire des transactions.",
    selectFile: "Veuillez sÃ©lectionner un fichier.",
    uploading: "TÃ©lÃ©chargement du fichier, cela peut prendre du temps...",
    uploadError: "Une erreur s'est produite lors du tÃ©lÃ©chargement:",
    loginRequired: "Vous devez signer le message pour vous connecter.",
    installMetaMask: "Veuillez installer le wallet MetaMask pour utiliser cette fonctionnalitÃ©.",
    voiceLoginRequired: "Veuillez connecter votre wallet avant d'utiliser les commandes vocales.",
    speechError: "Erreur de reconnaissance vocale:",
    loginSuccess: "ConnectÃ©:",
    googleAuthSuccess: "âœ… ConnectÃ© avec succÃ¨s Ã  Google Calendar!",
    googleAuthError: "âŒ Une erreur s'est produite lors de la connexion Ã  Google Calendar.",
    popupBlocked: "Votre navigateur a bloquÃ© le popup. Veuillez autoriser les popups pour ce site pour voir le message de succÃ¨s.",
    chooseFileButton: "Choisir un Fichier",
    noFileChosen: "Aucun fichier choisi",
    logoutTitle: "DÃ©connexion"
},
it: {
    mainTitle: "Assistente Coopa",
    googleAuth: "Connetti a Google Calendar",
    walletConnect: "ğŸ¦Š Accedi con Wallet",
    uploadTitle: "ğŸ–¼ï¸ Carica Memoria Personale",
    descriptionPlaceholder: "Breve descrizione del file...",
    uploadButton: "Salva Memoria Permanentemente",
    promptPlaceholder: "Chiedi qualcosa a Coopa...",
    promptPlaceholderMic: "Chiedi qualcosa a Coopa o ğŸ¤",
    submitButton: "Invia",
    loadingText: "Preparando risposta...",
    listeningText: "Ascoltando...",
    walletConnectFirst: "Per favore connetti prima il tuo wallet per le transazioni...",
    walletLoginFirst: "Per favore connetti il tuo wallet prima di fare transazioni.",
    selectFile: "Per favore seleziona un file.",
    uploading: "Caricamento file, questo potrebbe richiedere del tempo...",
    uploadError: "Si Ã¨ verificato un errore durante il caricamento:",
    loginRequired: "Devi firmare il messaggio per accedere.",
    installMetaMask: "Per favore installa il wallet MetaMask per utilizzare questa funzionalitÃ .",
    voiceLoginRequired: "Per favore connetti il tuo wallet prima di usare i comandi vocali.",
    speechError: "Errore di riconoscimento vocale:",
    loginSuccess: "Accesso Effettuato:",
    googleAuthSuccess: "âœ… Connesso con successo a Google Calendar!",
    googleAuthError: "âŒ Si Ã¨ verificato un errore durante la connessione a Google Calendar.",
    popupBlocked: "Il tuo browser ha bloccato il popup. Per favore consenti i popup per questo sito per vedere il messaggio di successo.",
    chooseFileButton: "Scegli File",
    noFileChosen: "Nessun file scelto",
    logoutTitle: "Disconnetti"
},
zh: {
    mainTitle: "Coopa åŠ©æ‰‹",
    googleAuth: "è¿æ¥åˆ° Google æ—¥å†",
    walletConnect: "ğŸ¦Š ä½¿ç”¨é’±åŒ…ç™»å½•",
    uploadTitle: "ğŸ–¼ï¸ ä¸Šä¼ ä¸ªäººè®°å¿†",
    descriptionPlaceholder: "æ–‡ä»¶çš„ç®€çŸ­æè¿°...",
    uploadButton: "æ°¸ä¹…ä¿å­˜è®°å¿†",
    promptPlaceholder: "å‘ Coopa æé—®...",
    promptPlaceholderMic: "å‘ Coopa æé—®æˆ– ğŸ¤",
    submitButton: "å‘é€",
    loadingText: "æ­£åœ¨å‡†å¤‡å›å¤...",
    listeningText: "æ­£åœ¨è†å¬...",
    walletConnectFirst: "è¯·å…ˆè¿æ¥æ‚¨çš„é’±åŒ…è¿›è¡Œäº¤æ˜“...",
    walletLoginFirst: "è¯·åœ¨è¿›è¡Œäº¤æ˜“å‰è¿æ¥æ‚¨çš„é’±åŒ…ã€‚",
    selectFile: "è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ã€‚",
    uploading: "æ–‡ä»¶ä¸Šä¼ ä¸­ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...",
    uploadError: "ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š",
    loginRequired: "æ‚¨éœ€è¦ç­¾ç½²æ¶ˆæ¯æ‰èƒ½ç™»å½•ã€‚",
    installMetaMask: "è¯·å®‰è£… MetaMask é’±åŒ…ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚",
    voiceLoginRequired: "è¯·åœ¨ä½¿ç”¨è¯­éŸ³å‘½ä»¤å‰è¿æ¥æ‚¨çš„é’±åŒ…ã€‚",
    speechError: "è¯­éŸ³è¯†åˆ«é”™è¯¯ï¼š",
    loginSuccess: "å·²ç™»å½•ï¼š",
    googleAuthSuccess: "âœ… æˆåŠŸè¿æ¥åˆ° Google æ—¥å†ï¼",
    googleAuthError: "âŒ è¿æ¥ Google æ—¥å†æ—¶å‘ç”Ÿé”™è¯¯ã€‚",
    popupBlocked: "æ‚¨çš„æµè§ˆå™¨é˜»æ­¢äº†å¼¹å‡ºçª—å£ã€‚è¯·ä¸ºæ­¤ç«™ç‚¹å…è®¸å¼¹å‡ºçª—å£ä»¥æŸ¥çœ‹æˆåŠŸæ¶ˆæ¯ã€‚",
    chooseFileButton: "é€‰æ‹©æ–‡ä»¶",
    noFileChosen: "æœªé€‰æ‹©æ–‡ä»¶",
    logoutTitle: "ç™»å‡º"
},
de: {
    mainTitle: "Coopa Assistent",
    googleAuth: "Mit Google Kalender verbinden",
    walletConnect: "ğŸ¦Š Mit Wallet anmelden",
    uploadTitle: "ğŸ–¼ï¸ PersÃ¶nliche Erinnerung hochladen",
    descriptionPlaceholder: "Kurze Beschreibung der Datei...",
    uploadButton: "Erinnerung dauerhaft speichern",
    promptPlaceholder: "Fragen Sie Coopa etwas...",
    promptPlaceholderMic: "Fragen Sie Coopa etwas oder ğŸ¤",
    submitButton: "Senden",
    loadingText: "Antwort wird vorbereitet...",
    listeningText: "HÃ¶re zu...",
    walletConnectFirst: "Bitte verbinden Sie zuerst Ihr Wallet fÃ¼r Transaktionen...",
    walletLoginFirst: "Bitte verbinden Sie Ihr Wallet vor Transaktionen.",
    selectFile: "Bitte wÃ¤hlen Sie eine Datei aus.",
    uploading: "Datei wird hochgeladen, dies kann etwas dauern...",
    uploadError: "Ein Fehler beim Hochladen ist aufgetreten:",
    loginRequired: "Sie mÃ¼ssen die Nachricht signieren, um sich anzumelden.",
    installMetaMask: "Bitte installieren Sie das MetaMask Wallet, um diese Funktion zu nutzen.",
    voiceLoginRequired: "Bitte verbinden Sie Ihr Wallet vor der Nutzung von Sprachbefehlen.",
    speechError: "Spracherkennungsfehler:",
    loginSuccess: "Angemeldet:",
    googleAuthSuccess: "âœ… Erfolgreich mit Google Kalender verbunden!",
    googleAuthError: "âŒ Ein Fehler beim Verbinden mit Google Kalender ist aufgetreten.",
    popupBlocked: "Ihr Browser hat das Popup blockiert. Bitte erlauben Sie Popups fÃ¼r diese Seite, um die Erfolgsmeldung zu sehen.",
    chooseFileButton: "Datei WÃ¤hlen",
    noFileChosen: "Keine Datei gewÃ¤hlt",
    logoutTitle: "Abmelden"
},
ru: {
    mainTitle: "ĞŸĞ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº Coopa",
    googleAuth: "ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ Ğº Google ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ",
    walletConnect: "ğŸ¦Š Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· ĞšĞ¾ÑˆĞµĞ»Ñ‘Ğº",
    uploadTitle: "ğŸ–¼ï¸ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ›Ğ¸Ñ‡Ğ½ÑƒÑ ĞŸĞ°Ğ¼ÑÑ‚ÑŒ",
    descriptionPlaceholder: "ĞšÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ°...",
    uploadButton: "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞŸĞ°Ğ¼ÑÑ‚ÑŒ ĞĞ°Ğ²ÑĞµĞ³Ğ´Ğ°",
    promptPlaceholder: "Ğ¡Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚Ğµ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ñƒ Coopa...",
    promptPlaceholderMic: "Ğ¡Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚Ğµ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ñƒ Coopa Ğ¸Ğ»Ğ¸ ğŸ¤",
    submitButton: "ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ",
    loadingText: "ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°...",
    listeningText: "Ğ¡Ğ»ÑƒÑˆĞ°Ñ...",
    walletConnectFirst: "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ ĞºĞ¾ÑˆĞµĞ»Ñ‘Ğº Ğ´Ğ»Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹...",
    walletLoginFirst: "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ ĞºĞ¾ÑˆĞµĞ»Ñ‘Ğº Ğ¿ĞµÑ€ĞµĞ´ ÑĞ¾Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸ĞµĞ¼ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹.",
    selectFile: "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ».",
    uploading: "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ°, ÑÑ‚Ğ¾ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ½ÑÑ‚ÑŒ Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ...",
    uploadError: "ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ:",
    loginRequired: "Ğ’Ğ°Ğ¼ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´Ğ°.",
    installMetaMask: "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ĞºĞ¾ÑˆĞµĞ»Ñ‘Ğº MetaMask Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑÑ‚Ğ¾Ğ¹ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸.",
    voiceLoginRequired: "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ ĞºĞ¾ÑˆĞµĞ»Ñ‘Ğº Ğ¿ĞµÑ€ĞµĞ´ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ñ‹Ñ… ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´.",
    speechError: "ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ²Ğ°Ğ½Ğ¸Ñ Ñ€ĞµÑ‡Ğ¸:",
    loginSuccess: "Ğ’Ñ…Ğ¾Ğ´ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½:",
    googleAuthSuccess: "âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½ Ğº Google ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ!",
    googleAuthError: "âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¸ Ğº Google ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ.",
    popupBlocked: "Ğ’Ğ°Ñˆ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ» Ğ²ÑĞ¿Ğ»Ñ‹Ğ²Ğ°ÑÑ‰ĞµĞµ Ğ¾ĞºĞ½Ğ¾. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚Ğµ Ğ²ÑĞ¿Ğ»Ñ‹Ğ²Ğ°ÑÑ‰Ğ¸Ğµ Ğ¾ĞºĞ½Ğ° Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ ÑĞ°Ğ¹Ñ‚Ğ°, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± ÑƒÑĞ¿ĞµÑ…Ğµ.",
    chooseFileButton: "Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¤Ğ°Ğ¹Ğ»",
    noFileChosen: "Ğ¤Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½",
    logoutTitle: "Ğ’Ñ‹Ğ¹Ñ‚Ğ¸"
}
        };

        let currentLanguage = localStorage.getItem('coopaLanguage') || 'tr';
        
        const elements = { 
            form: document.getElementById('prompt-form'), 
            input: document.getElementById('prompt-input'), 
            chatContainer: document.getElementById('chat-container'), 
            submitButton: document.getElementById('submit-button'), 
            loadingIndicator: document.getElementById('loading-indicator'), 
            micButton: document.getElementById('mic-button'), 
            ttsButton: document.getElementById('tts-button'),
            connectWalletButton: document.getElementById('connect-wallet-button'), 
            walletInfo: document.getElementById('wallet-info'), 
            googleAuthSection: document.getElementById('google-auth-section'), 
            uploadForm: document.getElementById('upload-form'),
            languageSelect: document.getElementById('language-select'),
            fileInputLabel: document.getElementById('file-input-label'),
            fileChosen: document.getElementById('file-chosen'),
            walletAddress: document.getElementById('wallet-address'),
            logoutButton: document.getElementById('logout-button')
        };

        function updateLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('coopaLanguage', lang);
            document.documentElement.lang = lang;
            
            document.getElementById('main-title').textContent = translations[lang].mainTitle;
            document.getElementById('google-auth-link').textContent = translations[lang].googleAuth;
            elements.connectWalletButton.textContent = translations[lang].walletConnect;
            document.getElementById('upload-title').textContent = translations[lang].uploadTitle;
            document.getElementById('description-input').placeholder = translations[lang].descriptionPlaceholder;
            document.getElementById('upload-button').textContent = translations[lang].uploadButton;
            elements.submitButton.textContent = translations[lang].submitButton;
            document.getElementById('loading-text').textContent = translations[lang].loadingText;
            elements.logoutButton.title = translations[lang].logoutTitle;

            elements.fileInputLabel.textContent = translations[lang].chooseFileButton;
            const fileInput = document.getElementById('file-input');
            elements.fileChosen.textContent = fileInput.files.length > 0 
                ? fileInput.files[0].name 
                : translations[lang].noFileChosen;
            
            if (isWalletConnected) {
                elements.input.placeholder = translations[lang].promptPlaceholderMic;
            } else {
                elements.input.placeholder = translations[lang].walletConnectFirst;
            }
        }

        function t(key) {
            return translations[currentLanguage][key] || translations['tr'][key] || key;
        }

        let conversationHistory = []; 
        let currentUserAddress = null; 
        let sessionSignature = null; 
        let isWalletConnected = false; 
        let isTtsEnabled = localStorage.getItem('ttsEnabled') === 'true'; 
        const synth = window.speechSynthesis;

        const speak = (text) => {
    if (!isTtsEnabled || !text) return;
    
    // Her zaman Ã¶nce mevcut konuÅŸmayÄ± iptal et
    synth.cancel();
    
    // KÄ±sa bir gecikme ekle (tarayÄ±cÄ±nÄ±n temizlemesi iÃ§in)
    setTimeout(() => {
        const utterThis = new SpeechSynthesisUtterance(text);
        
        // Dil kodlarÄ±
        switch(currentLanguage) {
            case 'tr': utterThis.lang = 'tr-TR'; break;
            case 'en': utterThis.lang = 'en-US'; break;
            case 'es': utterThis.lang = 'es-ES'; break;
            case 'fr': utterThis.lang = 'fr-FR'; break;
            case 'it': utterThis.lang = 'it-IT'; break;
            case 'zh': utterThis.lang = 'zh-CN'; break;
            case 'de': utterThis.lang = 'de-DE'; break;
            case 'ru': utterThis.lang = 'ru-RU'; break;
            default: utterThis.lang = 'en-US';
        }
        
        synth.speak(utterThis);
    }, 100);
};
        
        const toggleForm = (disabled, reason = 'loading') => { 
            elements.input.disabled = disabled; 
            elements.submitButton.disabled = disabled; 
            elements.micButton.disabled = disabled; 
            elements.ttsButton.disabled = disabled; 
            elements.loadingIndicator.style.display = (disabled && reason === 'loading') ? 'block' : 'none'; 
            if (disabled) { 
                if (reason === 'wallet') elements.input.placeholder = t('walletConnectFirst'); 
            } else { 
                elements.input.placeholder = t('promptPlaceholderMic'); 
                elements.input.focus(); 
            } 
        };

        // index.html dosyasÄ±ndaki mevcut displayMemory fonksiyonunu SÄ°LÄ°N ve yerine bunu YAPIÅTIRIN.

// index.html iÃ§ine - mevcut displayMemory fonksiyonuyla deÄŸiÅŸtirin
const displayMemory = (memoryData) => {
    if (!memoryData || !memoryData.decryptedDataUrl) return;

    const messageDiv = document.createElement('div');
    messageDiv.className = 'message model-message';

    let contentHTML = `<p>${currentLanguage === 'tr' ? 'Ä°steÄŸiniz Ã¼zerine bulunan anÄ±:' : 'Memory found as per your request:'}</p><p><em>${memoryData.description}</em></p>`;

    const mediaType = memoryData.mediaType || 'application/octet-stream'; 
    const dataUrl = memoryData.decryptedDataUrl;
    const description = memoryData.description || 'file';

    // EÄŸer medya tÃ¼rÃ¼ genel bir tÃ¼rse ("bilinmeyen"), aÃ§Ä±klama iÃ§inde resim uzantÄ±sÄ± arayarak
    // bunun bir resim olup olmadÄ±ÄŸÄ±nÄ± anlamaya Ã§alÄ±ÅŸalÄ±m.
    let isLikelyImage = mediaType.startsWith('image/');
    if (!isLikelyImage && mediaType === 'application/octet-stream') {
        const descLowerCase = description.toLowerCase();
        if (descLowerCase.endsWith('.jpg') || descLowerCase.endsWith('.jpeg') || descLowerCase.endsWith('.png') || descLowerCase.endsWith('.gif') || descLowerCase.endsWith('.webp')) {
            isLikelyImage = true;
        }
    }

    if (isLikelyImage) {
        contentHTML += `<img src="${dataUrl}" class="memory-image" alt="${description}" style="max-width: 100%; border-radius: 12px; margin-top: 10px;">`;
        contentHTML += `<div style="text-align: right; margin-top: 5px; font-size: 12px;"><a href="${dataUrl}" download="${description || 'coopa-image'}">GÃ¶rseli Ä°ndir</a></div>`;
    } else if (mediaType.startsWith('video/')) {
        contentHTML += `<video src="${dataUrl}" controls class="memory-video" style="max-width: 100%; border-radius: 12px; margin-top: 10px;"></video>`;
    } else if (mediaType === 'application/pdf') {
        contentHTML += `<embed src="${dataUrl}" type="application/pdf" width="100%" height="500px" class="memory-pdf" style="border: 1px solid #ddd; border-radius: 12px; margin-top: 10px;">`;
    } else {
        contentHTML += `<div style="margin-top: 10px; padding: 15px; background-color: #f0f0f0; border-radius: 8px;">
                            <p><strong>Ä°ndirilebilir Dosya:</strong> ${description}</p>
                            <a href="${dataUrl}" download="${description.replace(/[^a-z0-9.]/gi, '_').toLowerCase() || 'coopa-memory-file'}">DosyayÄ± Ä°ndir</a>
                       </div>`;
    }

    messageDiv.innerHTML = contentHTML;
    elements.chatContainer.appendChild(messageDiv);
    elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
};


        const renderHistory = (isNewMessage = false) => {
    elements.chatContainer.innerHTML = '';
    let lastModelMessageText = '';
    conversationHistory.forEach(message => {
        if (message.role === 'function' || !message.parts?.[0]) return;
        const messageDiv = document.createElement('div');
        const part = message.parts[0];
        if (message.role === 'user') {
            messageDiv.className = 'message user-message';
            messageDiv.innerText = part.text;
        } else if (message.role === 'model') {
            messageDiv.className = 'message model-message';
            if (part.text) {
                const linkify = (text) => text.replace(/(https?:\/\/[^\s]+)/g, (url) => `<a href="${url}" target="_blank">${url}</a>`);
                messageDiv.innerHTML = linkify(part.text);
                lastModelMessageText = part.text;
            } else if (part.functionCall) {
                const toolTexts = {
                    tr: `[Coopa, ${part.functionCall.name} aracÄ±nÄ± kullanÄ±yor...]`,
                    en: `[Coopa is using the ${part.functionCall.name} tool...]`,
                    es: `[Coopa estÃ¡ usando la herramienta ${part.functionCall.name}...]`
                };
                messageDiv.innerText = toolTexts[currentLanguage] || toolTexts['tr'];
                messageDiv.style.fontStyle = 'italic';
            }
        }
        elements.chatContainer.appendChild(messageDiv);
    });
    elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
    
    // Sadece yeni AI mesajÄ± geldiÄŸinde sesli oku
    if (isNewMessage && lastModelMessageText && lastModelMessageText.trim()) {
        synth.cancel();
        setTimeout(() => synth.cancel(), 50);
        setTimeout(() => {
            speak(lastModelMessageText);
        }, 100);
    }
};
        
    const handleFormSubmit = async (event) => {
    if (event) event.preventDefault();
    if (!isWalletConnected) { 
        alert(t('walletLoginFirst')); 
        return; 
    }

    // Timezone tespiti - BU SATIRI EKLEYÄ°N
    const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

    const prompt = elements.input.value;
    if (!prompt.trim()) return;
    
    conversationHistory.push({ role: 'user', parts: [{ text: prompt }] });
    renderHistory(); // Loading sÄ±rasÄ±nda ses yok
    toggleForm(true, 'loading');
    elements.input.value = '';

    try {
        const response = await fetch('/generate', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Accept-Language': currentLanguage 
            },
            body: JSON.stringify({ 
                prompt: prompt, 
                history: conversationHistory.slice(0, -1), 
                userAddress: currentUserAddress, 
                signature: sessionSignature,
                lang: currentLanguage,  // SeÃ§ili dili body'de gÃ¶nder
                timezone: userTimezone  // Timezone'u da gÃ¶nder
            })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Sunucu hatasÄ±');
                         
        conversationHistory = data.history;
        renderHistory(true); // YENÄ° AI MESAJI - SES VAR
        if (data.displayData) {
            displayMemory(data.displayData);
        }
        sessionStorage.setItem('coopaChatHistory', JSON.stringify(conversationHistory));
    } catch (error) {
        const errorMessages = {
            tr: `Bir hata oluÅŸtu: ${error.message}`,
            en: `An error occurred: ${error.message}`,
            es: `OcurriÃ³ un error: ${error.message}`
        };
        conversationHistory.push({ 
            role: 'model', 
            parts: [{ text: errorMessages[currentLanguage] || errorMessages['tr'] }] 
        });
        renderHistory(true); // HATA MESAJI - SES VAR
        sessionStorage.setItem('coopaChatHistory', JSON.stringify(conversationHistory));
    } finally {
        toggleForm(isWalletConnected ? false : true, 'wallet');
    }
};

        const handleLogout = () => {
            currentUserAddress = null;
            sessionSignature = null;
            isWalletConnected = false;
            conversationHistory = [];

            sessionStorage.removeItem('coopaUserAddress');
            sessionStorage.removeItem('coopaSessionSignature');
            sessionStorage.removeItem('coopaChatHistory');

            elements.walletInfo.style.display = 'none';
            elements.connectWalletButton.style.display = 'block';
            renderHistory();
            toggleForm(true, 'wallet');
        };

        const handleLogin = async () => { 
            if (typeof window.ethereum !== 'undefined') { 
                try { 
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' }); 
                    const account = accounts[0]; 
                    const signMessage = "Bu, CoopaASI iÃ§in kalÄ±cÄ± ÅŸifreleme anahtarÄ±mÄ± oluÅŸturacak ve bu anahtar baÅŸka bir amaÃ§ iÃ§in kullanÄ±lmayacaktÄ±r.";
                    const signature = await window.ethereum.request({ method: 'personal_sign', params: [signMessage, account] }); 
                    currentUserAddress = account; 
                    sessionSignature = signature; 
                    isWalletConnected = true; 
                    
                    const shortAddress = `${account.substring(0, 6)}...${account.substring(account.length - 4)}`; 
                    elements.walletAddress.textContent = `${t('loginSuccess')} ${shortAddress}`;
                    elements.walletInfo.style.display = 'flex';
                    elements.connectWalletButton.style.display = 'none'; 
                    elements.logoutButton.addEventListener('click', handleLogout);

                    sessionStorage.setItem('coopaUserAddress', account);
                    sessionStorage.setItem('coopaSessionSignature', signature);

                    toggleForm(false); 
                } catch (error) { 
                    console.error("GiriÅŸ ve imzalama hatasÄ±:", error); 
                    alert(t('loginRequired')); 
                } 
            } else { 
                alert(t('installMetaMask')); 
            } 
        };

        const handleUpload = async (event) => { 
            event.preventDefault(); 
            if (!isWalletConnected || !sessionSignature) { return alert(t('walletLoginFirst')); } 
            
            const formData = new FormData(); 
            const fileInput = document.getElementById('file-input'); 
            const descriptionInput = document.getElementById('description-input'); 
            
            if (!fileInput.files[0]) return alert(t('selectFile')); 
            
            formData.append('memoryFile', fileInput.files[0]); 
            formData.append('description', descriptionInput.value); 
            formData.append('userAddress', currentUserAddress); 
            formData.append('signature', sessionSignature); 
            alert(t('uploading')); 
            
            try { 
                const response = await fetch('/upload', { 
                    method: 'POST', 
                    headers: { 'Accept-Language': currentLanguage },
                    body: formData 
                }); 
                const resultHtml = await response.text(); 
                if (!response.ok) throw new Error(resultHtml); 

                const newWindow = window.open(); 
                if (newWindow) {
                    newWindow.document.write(resultHtml); 
                    newWindow.document.close(); 
                } else {
                    alert(t('popupBlocked'));
                }

                fileInput.value = ''; 
                descriptionInput.value = '';
                document.getElementById('file-chosen').textContent = t('noFileChosen');
            } catch (error) { 
                alert(`${t('uploadError')} ${error.message}`); 
            } 
        };
        
        // Event listeners
        elements.form.addEventListener('submit', handleFormSubmit);
        elements.uploadForm.addEventListener('submit', handleUpload);
        elements.connectWalletButton.addEventListener('click', handleLogin);
        
        document.getElementById('file-input').addEventListener('change', function() {
            const fileChosenSpan = document.getElementById('file-chosen');
            if (this.files.length > 0) {
                fileChosenSpan.textContent = this.files[0].name;
            } else {
                fileChosenSpan.textContent = t('noFileChosen');
            }
        });
        
        elements.languageSelect.addEventListener('change', (e) => {
            updateLanguage(e.target.value);
        });

        const updateTtsButtonIcon = () => elements.ttsButton.textContent = isTtsEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
        
        window.onload = () => {
            elements.languageSelect.value = currentLanguage;
            updateLanguage(currentLanguage);
            
            const savedAddress = sessionStorage.getItem('coopaUserAddress');
            const savedSignature = sessionStorage.getItem('coopaSessionSignature');

            if (savedAddress && savedSignature) {
                currentUserAddress = savedAddress;
                sessionSignature = savedSignature;
                isWalletConnected = true;

                const shortAddress = `${savedAddress.substring(0, 6)}...${savedAddress.substring(savedAddress.length - 4)}`;
                elements.walletAddress.textContent = `${t('loginSuccess')} ${shortAddress}`;
                elements.walletInfo.style.display = 'flex';
                elements.connectWalletButton.style.display = 'none';
                elements.logoutButton.addEventListener('click', handleLogout);
                
                const savedHistory = sessionStorage.getItem('coopaChatHistory');
                if (savedHistory) {
                    conversationHistory = JSON.parse(savedHistory);
                    renderHistory();
                }

                toggleForm(false);
            } else {
                toggleForm(true, 'wallet');
            }

            updateTtsButtonIcon();
            
            elements.ttsButton.addEventListener('click', () => { 
                isTtsEnabled = !isTtsEnabled; 
                localStorage.setItem('ttsEnabled', isTtsEnabled ? 'true' : 'false'); 
                updateTtsButtonIcon(); 
                if (!isTtsEnabled) synth.cancel(); 
            });
            
            const params = new URLSearchParams(window.location.search);
            if (params.get('auth')) { 
                const authStatus = params.get('auth'); 
                const div = document.createElement('div'); 
                div.innerText = authStatus === 'success' ? t('googleAuthSuccess') : t('googleAuthError'); 
                div.style.color = authStatus === 'success' ? 'green' : 'red'; 
                elements.googleAuthSection.innerHTML = ''; 
                elements.googleAuthSection.appendChild(div); 
                speak(div.innerText); 
            }
        };
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) { 
            const recognition = new SpeechRecognition(); 
            recognition.continuous = false; 
            
            const updateRecognitionLanguage = () => {
                recognition.lang = currentLanguage === 'tr' ? 'tr-TR' : currentLanguage === 'es' ? 'es-ES' : 'en-US';
            };
            updateRecognitionLanguage();
            
            elements.languageSelect.addEventListener('change', updateRecognitionLanguage);
            
            elements.micButton.addEventListener('click', () => { 
                if (!isWalletConnected) { 
                    alert(t('voiceLoginRequired')); 
                    return; 
                } 
                synth.cancel(); 
                recognition.start(); 
            }); 
            
            recognition.onstart = () => { 
                elements.micButton.classList.add('listening'); 
                elements.input.placeholder = t('listeningText'); 
            }; 
            
            recognition.onend = () => { 
                elements.micButton.classList.remove('listening'); 
                if (isWalletConnected) { 
                    elements.input.placeholder = t('promptPlaceholderMic'); 
                } 
            }; 
            
            recognition.onresult = (event) => { 
                const transcript = event.results[event.results.length - 1][0].transcript.trim(); 
                elements.input.value = transcript; 
                synth.cancel();
                setTimeout(() => synth.cancel(), 50);
                handleFormSubmit(); 
            }; 
            
            recognition.onerror = (event) => { 
                alert(`${t('speechError')} ${event.error}`); 
            }; 
        } else { 
            elements.micButton.style.display = 'none'; 
        }
    </script>
</body>
</html>